<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Admin</title>
    <%- include layout/head %>
        <link rel="stylesheet" type="text/css" href="/static/css/homepage.css">
</head>

<body>
    <div class="container">
        <div class="row" style="margin-bottom: 10px; margin-top: 10px;">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <h3 class="pull-left">Hello
                    <% if(data && data.fullname)%>
                        <%=data.fullname %>
                </h3>
                <a class="btn btn-info pull-right" href="/logout">Logout</a>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">Files</div>
            <!-- /.panel-heading -->
            <div class="panel-body title-upload">
                <span class="glyphicon glyphicon-cloud-upload"></span>
                <h2>File Upload</h2>
                <div id="drop_zone">Drop files here</div>
                <output id="list"></output>
                <div class="progress">
                    <div class="progress-bar" role="progressbar"></div>
                </div>
                <input id="upload-input" multiple="multiple" name="uploads[]" style="display: none;" type="file" />
            </div>
        </div>
    </div>
    <script>
        function handleFileSelect(evt) {
            evt.stopPropagation();
            evt.preventDefault();

            var files = evt.dataTransfer.files; // FileList object.

            console.log(files);

            // Upfile to server.
            if (files.length > 0) {
                // Create a FormData object which will be sent as the data payload in the
                // AJAX request
                var formData = new FormData();

                // Loop through all the selected files and add them to the formData object
                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    console.log(file);

                    // Add the files to formData object for the data payload
                    formData.append('uploads[]', file, file.name);
                }
                console.log(formData);

                $.ajax({
                    url: '/homepage',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(data) {
                        console.log('Upload successful!\n' + data);
                    },
                    xhr: function() {
                        // create an XMLHttpRequest
                        var xhr = new XMLHttpRequest();

                        // listen to the 'progress' event
                        xhr.upload.addEventListener('progress', function(evt) {

                            if (evt.lengthComputable) {
                                // calculate the percentage of upload completed
                                var percentComplete = evt.loaded / evt.total;
                                percentComplete = parseInt(percentComplete * 100);

                                // update the Bootstrap progress bar with the new percentage
                                $('.progress-bar').text(percentComplete + '%');
                                $('.progress-bar').width(percentComplete + '%');

                                // once the upload reaches 100%, set the progress bar text to done
                                if (percentComplete === 100) {
                                    $('.progress-bar').html('Done');
                                }
                            }
                        }, false);
                        return xhr;
                    }
                });
            }
            //-----------------

            // $.ajax({
            //     url: '/path/to/file',
            //     type: 'default GET (Other values: POST)',
            //     dataType: 'default: Intelligent Guess (Other values: xml, json, script, or html)',
            //     data: {param1: 'value1'},
            // })
            // .done(function() {
            //     console.log("success");
            // })
            // .fail(function() {
            //     console.log("error");
            // })
            // .always(function() {
            //     console.log("complete");
            // });


            // files is a FileList of File objects. List some properties.
            var output = [];
            for (var i = 0, f; f = files[i]; i++) {
                output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
                    f.size, ' bytes, last modified: ',
                    f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
                    '</li>');
            }
            document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
        }

        function handleDragOver(evt) {
            evt.stopPropagation();
            evt.preventDefault();
            evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
        }

        // Setup the dnd listeners.
        var dropZone = document.getElementById('drop_zone');
        dropZone.addEventListener('dragover', handleDragOver, false);
        dropZone.addEventListener('drop', handleFileSelect, false);
    </script>
    <!-- /.panel-body -->
    <!-- <script src="/static/js/upload.js"></script> -->
</body>

</html>